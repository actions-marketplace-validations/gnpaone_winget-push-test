name: CI

on:
  schedule:
    - cron: '0 10 * * *' # everyday at 10am
  push:
    branches:
      - 'master'
      - 'releases/v*'
  pull_request:
    branches:
      - 'master'
      - 'releases/v*'

jobs:
  single-url:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        with:
          url: https://github.com/test-user/test-repo/releases/download/v1.0.0/test-url.exe
          version: 1.0.0
          token: ${{ secrets.GITHUB_TOKEN }}
          id: test.package
          user: microsoft
          repo: winget-pkgs
        id: single
      - run: |
          $url="${{ steps.single.with.url }}"
          $version="${{ steps.single.with.version }}"
          curl https://github.com/microsoft/winget-create/releases/latest/download/wingetcreate-self-contained.exe -O wingetcreate-self-contained.exe
          ./wingetcreate-self-contained.exe settings
          $pathToJson = "$env:LOCALAPPDATA\Microsoft\WindowsPackageManagerManifestCreator\settings.json"
          $pathTest = Get-Content $pathToJson | ConvertFrom-Json
          $pathTest.WindowsPackageManagerRepository.owner = "${{ steps.single.with.user }}"
          $pathTest.WindowsPackageManagerRepository.name = "${{ steps.single.with.repo }}"
          $pathTest | ConvertTo-Json | set-content $pathToJson
          Copy-Item -Path $env:LOCALAPPDATA\Microsoft\WindowsPackageManagerManifestCreator\settings.json -Destination C:\settings.json -PassThru
          ./wingetcreate-self-contained.exe update -u "$url" -v $version -t "${{ steps.single.with.token }}" -s "${{ steps.single.with.id }}"
      
